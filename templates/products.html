{% extends "base.html" %}
{% block title %}Products - POS Dashboard{% endblock %}

{% block content %}
<h4>Products: {{ display }}</h4>

<!-- Period navigation -->
<div class="period-nav">
    <a href="/products?period=today" {% if period == 'today' %}aria-current="true"{% endif %}>Today</a>
    <a href="/products?period=week" {% if period == 'week' %}aria-current="true"{% endif %}>Last 7 Days</a>
    <a href="/products?period=month" {% if period == 'month' %}aria-current="true"{% endif %}>Last 30 Days</a>
</div>

<!-- Metric cards -->
<div class="grid-metrics">
    <div class="card metric">
        <p class="value">{{ "%.0f" | format(total_items) }}</p>
        <p class="label">Items Sold</p>
    </div>
    <div class="card metric">
        <p class="value">{{ format_currency(total_revenue) }}</p>
        <p class="label">Revenue</p>
    </div>
    <div class="card metric">
        <p class="value">{{ format_currency(total_profit) }}</p>
        <p class="label">Profit</p>
    </div>
</div>

<!-- Charts -->
<div class="charts-grid">
    <div class="card chart-container">
        <h6>Revenue Distribution</h6>
        <canvas id="productsPieChart"></canvas>
    </div>
    {% if category_data != "null" %}
    <div class="card chart-container">
        <h6>Revenue by Category</h6>
        <canvas id="categoryPieChart"></canvas>
    </div>
    {% endif %}
</div>

<div class="card chart-container">
    <h6>Products by Revenue</h6>
    <canvas id="productsBarChart"></canvas>
</div>

<!-- Category filter -->
{% if categories|length > 1 %}
<div style="margin-bottom: 1rem;">
    <select id="categoryFilter" aria-label="Filter by category">
        <option value="">All Categories</option>
        {% for cat in categories %}
        <option value="{{ cat }}">{{ cat }}</option>
        {% endfor %}
    </select>
</div>
{% endif %}

<!-- Product table -->
{% if products %}
<div class="card">
    <table class="product-table sortable-table" role="grid">
        <thead>
            <tr>
                <th data-sort="rank">#</th>
                <th data-sort="product">Product</th>
                <th data-sort="category">Category</th>
                <th data-sort="qty">Qty</th>
                <th data-sort="revenue">Revenue</th>
                <th data-sort="profit">Profit</th>
                <th data-sort="margin">Margin</th>
            </tr>
        </thead>
        <tbody>
            {% for p in products %}
            <tr data-category="{{ p.category_name }}">
                <td data-value="{{ loop.index }}">{{ loop.index }}</td>
                <td>{{ p.product_name }}</td>
                <td>{{ p.category_name }}</td>
                <td data-value="{{ p.count }}">{{ "%.0f" | format(p.count) }}</td>
                <td data-value="{{ p.payed_sum }}">{{ format_currency(p.payed_sum) }}</td>
                <td data-value="{{ p.product_profit }}">{{ format_currency(p.product_profit) }}</td>
                {% set margin = (p.product_profit / p.payed_sum * 100) if p.payed_sum > 0 else 0 %}
                <td data-value="{{ "%.1f"|format(margin) }}">{{ "%.0f"|format(margin) }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p style="text-align:center; opacity:0.5;">No product data for this period.</p>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
    const barData = {{ bar_data | safe }};
    const pieData = {{ pie_data | safe }};
    const categoryData = {{ category_data | safe }};

    // Top products horizontal bar chart
    if (barData && barData.labels.length > 0) {
        renderHorizontalBarChart('productsBarChart', barData.labels, [
            { label: 'Revenue', data: barData.revenue.map(v => v / 100), backgroundColor: 'rgba(33, 150, 243, 0.7)' },
            { label: 'Profit', data: barData.profit.map(v => v / 100), backgroundColor: 'rgba(76, 175, 80, 0.7)' }
        ]);
    }

    // Revenue pie chart
    if (pieData && pieData.labels.length > 0) {
        renderPieChart('productsPieChart', pieData.labels, pieData.values.map(v => v / 100));
    }

    // Revenue by category pie chart
    if (categoryData && categoryData.labels.length > 0) {
        renderPieChart('categoryPieChart', categoryData.labels, categoryData.revenue.map(v => v / 100));
    }

    // Category filter
    const categoryFilter = document.getElementById('categoryFilter');
    if (categoryFilter) {
        categoryFilter.addEventListener('change', function() {
            const selected = this.value;
            const rows = document.querySelectorAll('.product-table tbody tr');
            let rank = 0;
            rows.forEach(function(row) {
                if (!selected || row.dataset.category === selected) {
                    row.style.display = '';
                    rank++;
                    row.children[0].textContent = rank;
                    row.children[0].dataset.value = rank;
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
</script>
{% endblock %}
