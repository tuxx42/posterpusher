{% extends "base.html" %}
{% block title %}Summary - POS Dashboard{% endblock %}

{% block content %}
{% if period == 'custom' and date_from_iso and date_from_iso == date_to_iso %}
<h4 style="display:flex; align-items:center; gap:0.5rem;">
    <a href="/summary?period=custom&date_from={{ prev_day }}&date_to={{ prev_day }}" style="text-decoration:none; font-size:1.2rem; opacity:0.7;">&larr;</a>
    Summary: {{ display }}
    <a href="/summary?period=custom&date_from={{ next_day }}&date_to={{ next_day }}" style="text-decoration:none; font-size:1.2rem; opacity:0.7;">&rarr;</a>
</h4>
{% else %}
<h4>Summary: {{ display }}</h4>
{% endif %}

<!-- Period navigation -->
<div class="period-nav">
    <a href="/summary?period=today" {% if period == 'today' %}aria-current="true"{% endif %}>Today</a>
    <a href="/summary?period=week" {% if period == 'week' %}aria-current="true"{% endif %}>Last 7 Days</a>
    <a href="/summary?period=month" {% if period == 'month' %}aria-current="true"{% endif %}>Last 30 Days</a>
    <a href="#" id="custom-toggle" {% if period == 'custom' %}aria-current="true"{% endif %}>Custom</a>
</div>
<div id="custom-range" class="custom-range" {% if period != 'custom' %}style="display:none"{% endif %}>
    <form method="get" action="/summary" id="custom-range-form">
        <input type="hidden" name="period" value="custom">
        <input type="hidden" name="date_from" id="date_from" value="{{ date_from_iso or '' }}">
        <input type="hidden" name="date_to" id="date_to" value="{{ date_to_iso or '' }}">
        <input type="text" id="date-range-picker" placeholder="Select date range…" readonly required>
        <button type="submit">Go</button>
    </form>
</div>

<!-- Metric cards -->
<div class="grid-metrics">
    <div class="card metric">
        <p class="value">{{ summary.transaction_count }}</p>
        <p class="label">Transactions</p>
    </div>
    <div class="card metric">
        <p class="value">{{ format_currency(summary.total_sales, short=True) }}</p>
        <p class="label">Total Sales</p>
    </div>
    <div class="card metric">
        <p class="value">{{ format_currency(summary.total_profit, short=True) }}</p>
        <p class="label">Gross Profit</p>
    </div>
    <div class="card metric">
        <p class="value">{{ format_currency(expenses.total_expenses, short=True) }}</p>
        <p class="label">Expenses</p>
    </div>
    <div class="card metric">
        <p class="value">{{ format_currency(net_profit, short=True) }}</p>
        <p class="label">Net Profit</p>
    </div>
    <div class="card metric">
        <p class="value">{{ format_currency(summary.cash_sales, short=True) }}</p>
        <p class="label">Cash</p>
    </div>
    <div class="card metric">
        <p class="value">{{ format_currency(summary.card_sales, short=True) }}</p>
        <p class="label">Card</p>
    </div>
    {% if monthly_goal > 0 %}
    <div class="card metric">
        <p class="value" style="color: {{ '#4CAF50' if goal_percent_adjusted >= 100 else '#FF9800' if goal_percent_adjusted >= 75 else '#f44336' }}">{{ "%.0f"|format(goal_percent_adjusted) }}%</p>
        <p class="label">Goal (pace)</p>
        <p style="font-size:0.75rem; opacity:0.7; margin:0">{{ "%.0f"|format(goal_percent) }}% overall · {{ format_currency(goal_progress, short=True) }} / {{ format_currency(goal_adjusted, short=True) }}</p>
    </div>
    {% endif %}
</div>

<!-- Charts -->
<div class="charts-grid">
    <div class="card chart-container">
        <h6>Daily Breakdown</h6>
        <canvas id="dailyChart"></canvas>
    </div>
    {% if hourly_data != "null" %}
    <div class="card chart-container">
        <h6>Hourly Breakdown</h6>
        <canvas id="hourlyChart"></canvas>
    </div>
    {% endif %}
    {% if expense_pie_data != "null" %}
    <div class="card chart-container">
        <h6>Expenses Breakdown</h6>
        <canvas id="expensePieChart"></canvas>
    </div>
    {% endif %}
    {% if cash_timeline != "null" %}
    <div class="card chart-container">
        <h6>Cash in Register</h6>
        <canvas id="cashTimelineChart"></canvas>
    </div>
    {% endif %}
</div>

{% if all_transactions %}
<div class="card">
    <h6>Transactions</h6>
    <table class="product-table sortable-table" id="transactions-table" role="grid">
        <thead>
            <tr>
                <th data-sort="date">Date</th>
                <th data-sort="type">Type</th>
                <th data-sort="description">Description</th>
                <th data-sort="amount">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for txn in all_transactions %}
            <tr>
                <td data-value="{{ txn.date }}">{{ txn.date }}</td>
                <td>{{ txn.type | capitalize }}</td>
                <td>{{ txn.description }}</td>
                {% if txn.type == 'expense' %}
                <td data-value="-{{ txn.amount }}" style="color: #f44336; text-align: right;">-{{ format_currency(txn.amount) }}</td>
                {% else %}
                <td data-value="{{ txn.amount }}" style="color: #4CAF50; text-align: right;">{{ format_currency(txn.amount) }}</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
    const dailyData = {{ daily_data | safe }};
    const hourlyData = {{ hourly_data | safe }};
    const expensePieData = {{ expense_pie_data | safe }};
    const cashTimelineData = {{ cash_timeline | safe }};

    // Daily breakdown chart
    if (dailyData && dailyData.labels.length > 0) {
        renderBarChart('dailyChart', dailyData.labels, [
            { label: 'Sales', data: dailyData.sales.map(v => v / 100), backgroundColor: 'rgba(33, 150, 243, 0.7)' },
            { label: 'Profit', data: dailyData.profit.map(v => v / 100), backgroundColor: 'rgba(76, 175, 80, 0.7)' }
        ]);
    }

    // Hourly breakdown chart (today only)
    if (hourlyData && hourlyData.labels) {
        // Filter to only show hours with data
        const start = hourlyData.sales.findIndex(v => v > 0);
        const end = hourlyData.sales.length - 1 - [...hourlyData.sales].reverse().findIndex(v => v > 0);
        if (start >= 0) {
            const labels = hourlyData.labels.slice(start, end + 1);
            const sales = hourlyData.sales.slice(start, end + 1);
            const profit = hourlyData.profit.slice(start, end + 1);
            renderBarChart('hourlyChart', labels, [
                { label: 'Sales', data: sales.map(v => v / 100), backgroundColor: 'rgba(33, 150, 243, 0.7)' },
                { label: 'Profit', data: profit.map(v => v / 100), backgroundColor: 'rgba(76, 175, 80, 0.7)' }
            ]);
        }
    }

    // Expense breakdown pie chart
    if (expensePieData && expensePieData.labels.length > 0) {
        renderPieChart('expensePieChart', expensePieData.labels, expensePieData.values.map(v => v / 100));
    }

    // Cash in register timeline
    if (cashTimelineData && cashTimelineData.points.length > 0) {
        renderTimeLineChart('cashTimelineChart', [
            {
                label: 'Cash in Register',
                data: cashTimelineData.points.map(p => ({x: p.x, y: p.y / 100})),
                borderColor: 'rgba(76, 175, 80, 0.9)',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                fill: true
            }
        ]);
    }

    // Flatpickr date range picker
    const dfVal = document.getElementById('date_from').value;
    const dtVal = document.getElementById('date_to').value;
    const fp = flatpickr('#date-range-picker', {
        mode: 'range',
        dateFormat: 'Y-m-d',
        defaultDate: (dfVal && dtVal) ? [dfVal, dtVal] : [],
        onChange: function(selectedDates) {
            const fmt = d => d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
            if (selectedDates.length === 2) {
                document.getElementById('date_from').value = fmt(selectedDates[0]);
                document.getElementById('date_to').value = fmt(selectedDates[1]);
            } else if (selectedDates.length === 1) {
                document.getElementById('date_from').value = fmt(selectedDates[0]);
                document.getElementById('date_to').value = fmt(selectedDates[0]);
            }
        },
        onClose: function(selectedDates) {
            if (selectedDates.length === 1) {
                const fmt = d => d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                const single = fmt(selectedDates[0]);
                document.getElementById('date_from').value = single;
                document.getElementById('date_to').value = single;
                fp.setDate([selectedDates[0], selectedDates[0]], true);
            }
        }
    });

    // Custom date range toggle
    document.getElementById('custom-toggle').addEventListener('click', function(e) {
        e.preventDefault();
        const panel = document.getElementById('custom-range');
        const visible = panel.style.display !== 'none';
        panel.style.display = visible ? 'none' : 'flex';
        if (!visible) fp.open();
    });
</script>
{% endblock %}
